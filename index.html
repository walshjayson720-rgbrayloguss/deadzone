<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Top Down Zombie Shooter</title>
<style>
  body {
    margin: 0;
    background: #111;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #222;
  }
</style>
</head>
<body>

<canvas id="game" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ---------------- PLAYER ----------------
const player = {
  x: 400,
  y: 300,
  radius: 15,
  speed: 3,
  maxHealth: 100,
  health: 100,
  regenDelay: 3000,
  lastHit: 0
};

// ---------------- GAME STATE ----------------
let bullets = [];
let zombies = [];
let keys = {};
let mouse = { x: 0, y: 0 };
let fireRate = 300;
let lastShot = 0;
let wave = 1;

// ---------------- PERKS (MERGED) ----------------
const perks = [
  {
    id: "faster_fire",
    apply() {
      fireRate *= 0.85;
    }
  },
  {
    id: "faster_regen",
    apply() {
      player.regenDelay *= 0.7;
    }
  },
  {
    id: "more_health",
    apply() {
      player.maxHealth += 25;
      player.health += 25;
    }
  },
  {
    id: "more_speed",
    apply() {
      player.speed *= 1.15;
    }
  }
];

function applyRandomPerk() {
  const perk = perks[Math.floor(Math.random() * perks.length)];
  perk.apply();
}

// ---------------- INPUT ----------------
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});

canvas.addEventListener("mousedown", shoot);

// ---------------- SHOOTING ----------------
function shoot() {
  if (Date.now() - lastShot < fireRate) return;
  lastShot = Date.now();

  const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
  bullets.push({
    x: player.x,
    y: player.y,
    dx: Math.cos(angle) * 7,
    dy: Math.sin(angle) * 7
  });
}

// ---------------- ZOMBIES ----------------
function spawnWave() {
  for (let i = 0; i < wave * 3; i++) {
    zombies.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      radius: 18,
      speed: 1 + wave * 0.1,
      health: 40 + wave * 10
    });
  }
}

spawnWave();

// ---------------- DAMAGE + REGEN ----------------
function takeDamage(amount) {
  player.health -= amount;
  player.lastHit = Date.now();
  if (player.health < 0) player.health = 0;
}

function regenHealth() {
  if (Date.now() - player.lastHit > player.regenDelay) {
    player.health += 0.05;
    if (player.health > player.maxHealth)
      player.health = player.maxHealth;
  }
}

// ---------------- UPDATE ----------------
function update() {
  // Movement
  let dx = 0, dy = 0;
  if (keys["w"]) dy--;
  if (keys["s"]) dy++;
  if (keys["a"]) dx--;
  if (keys["d"]) dx++;

  player.x += dx * player.speed;
  player.y += dy * player.speed;

  // Bullets
  bullets.forEach(b => {
    b.x += b.dx;
    b.y += b.dy;
  });

  // Zombies
  zombies.forEach(z => {
    const angle = Math.atan2(player.y - z.y, player.x - z.x);
    z.x += Math.cos(angle) * z.speed;
    z.y += Math.sin(angle) * z.speed;

    const dist = Math.hypot(player.x - z.x, player.y - z.y);
    if (dist < player.radius + z.radius) {
      takeDamage(10);
    }
  });

  // Bullet collision
  bullets.forEach((b, bi) => {
    zombies.forEach((z, zi) => {
      const dist = Math.hypot(b.x - z.x, b.y - z.y);
      if (dist < z.radius) {
        z.health -= 20;
        bullets.splice(bi, 1);
        if (z.health <= 0) zombies.splice(zi, 1);
      }
    });
  });

  // New wave + perk
  if (zombies.length === 0) {
    wave++;
    applyRandomPerk();
    spawnWave();
  }

  regenHealth();
}

// ---------------- DRAW ----------------
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Player
  ctx.fillStyle = "tan";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
  ctx.fill();

  // Bullets
  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, 3, 0, Math.PI * 2);
    ctx.fill();
  });

  // Zombies + health bars
  zombies.forEach(z => {
    ctx.fillStyle = "green";
    ctx.beginPath();
    ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "red";
    ctx.fillRect(z.x - 15, z.y - 25, 30 * (z.health / (40 + wave * 10)), 4);
  });

  // Player health bar (bottom middle)
  ctx.fillStyle = "red";
  ctx.fillRect(300, 560, 200 * (player.health / player.maxHealth), 10);

  // Wave counter (top right)
  ctx.fillStyle = "white";
  ctx.font = "16px Arial";
  ctx.fillText("Wave: " + wave, 700, 20);
}

// ---------------- LOOP ----------------
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
